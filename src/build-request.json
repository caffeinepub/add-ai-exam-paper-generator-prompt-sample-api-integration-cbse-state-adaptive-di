{
  "kind": "build_request",
  "title": "Fix onboarding profile creation permissions and add duplicate-email validation",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-28",
      "text": "Unblock self-service onboarding by ensuring an authenticated Internet Identity user can create their own non-admin profile (Student/Parent/Teacher) without receiving the authorization error \"You do not have permission to create this type of profile. Please contact an administrator.\"",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "getting this message and profile creation not working You do not have permission to create this type of profile. Please contact an administrator."
        ]
      },
      "acceptanceCriteria": [
        "When a logged-in user with no existing profile calls createUserProfile for role Student, Parent, or Teacher with principal == caller, the call succeeds and returns a new profile id (no permission/unauthorized trap).",
        "When an unauthenticated/anonymous caller attempts to create a profile, the backend rejects the request with a clear authentication-required error (no false 'permission to create this type of profile' message).",
        "Creating a School Admin profile via self-service remains disallowed unless explicitly authorized by an administrator (existing frontend restriction must remain effective; backend should not silently allow self-creation of schoolAdmin)."
      ]
    },
    {
      "id": "REQ-29",
      "text": "Implement backend email uniqueness validation during profile creation: if a new profile is created with an email that is already registered for any existing user, the backend must reject the creation with the exact error text \"Email already registered\".",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Please implement email validation same mail try to create show the error message : email already registered"
        ]
      },
      "acceptanceCriteria": [
        "If two different principals attempt to create profiles with the same email address, the second attempt fails and returns/traps with the exact message \"Email already registered\".",
        "Email uniqueness check is case-insensitive and ignores leading/trailing whitespace (e.g., \"Test@Email.com\" and \" test@email.com \" are treated as the same email).",
        "If a profile already exists for a principal, the existing behavior (rejecting duplicate principal profile creation) continues to work and does not mask the \"Email already registered\" error for the email-duplicate case."
      ]
    },
    {
      "id": "REQ-30",
      "text": "Update the onboarding UI error handling to show a specific user-facing error message \"Email already registered\" when the backend rejects profile creation due to duplicate email, and avoid showing the generic permission error for non-admin roles when the backend indicates a different failure reason.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Please implement email validation same mail try to create show the error message : email already registered"
        ]
      },
      "acceptanceCriteria": [
        "When backend profile creation fails with an error containing \"Email already registered\", the onboarding page displays exactly: \"Email already registered\" in the destructive alert.",
        "When backend profile creation fails for reasons other than authorization/permissions, the onboarding page does not incorrectly display: \"You do not have permission to create this type of profile. Please contact an administrator.\"",
        "Current successful flow remains: after a successful profile creation, the app invalidates/refetches ['currentUserProfile'] and AppShell proceeds to the appropriate dashboard without manual refresh."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor with all logic in backend/main.mo.",
    "Do not edit frontend files under frontend/src/components/ui or any paths listed in frontend.immutablePaths.",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Adding third-party authentication providers or email verification emails.",
    "Building an admin UI for managing users or schools.",
    "Adding an external database or off-chain persistence for email indexing."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}